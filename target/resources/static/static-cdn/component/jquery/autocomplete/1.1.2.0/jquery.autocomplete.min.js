(function($){$.fn.extend({autocomplete:function(_,B){var A=typeof _=="string";B=$.extend({},$.Autocompleter.defaults,{url:A?_:null,data:A?null:_,delay:A?$.Autocompleter.defaults.delay:10,max:B&&!B.scroll?1000:1500},B);B.highlight=B.highlight||function($){return $};B.formatMatch=B.formatMatch||B.formatItem;return this.each(function(){new $.Autocompleter(this,B)})},result:function($){return this.bind("result",$)},search:function($){return this.trigger("search",[$])},flushCache:function(){return this.trigger("flushCache")},setOptions:function($){return this.trigger("setOptions",[$])},unautocomplete:function(){return this.trigger("unautocomplete")}});$.Autocompleter=function(H,V){var E={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},R=$(H).attr("autocomplete","off").addClass(V.inputClass),S,Q="",B=$.Autocompleter.Cache(V),F=0,T,M={mouseDownOnSelect:false,containFocusFlag:false},C=$.Autocompleter.Select(V,H,_,M),L;navigator.userAgent.indexOf("Opera")!=-1&&$(H.form).bind("submit.autocomplete",function(){if(L){L=false;return false}});R.bind((navigator.userAgent.indexOf("Opera")!=-1?"keypress":"keyup")+".autocomplete",function(A){F=1;T=A.keyCode;switch(A.keyCode){case E.UP:A.preventDefault();if(C.visible())C.prev();else K(0,true);break;case E.DOWN:A.preventDefault();if(C.visible())C.next();else K(0,true);break;case E.PAGEUP:A.preventDefault();if(C.visible())C.pageUp();else K(0,true);break;case E.PAGEDOWN:A.preventDefault();if(C.visible())C.pageDown();else K(0,true);break;case V.multiple&&$.trim(V.multipleSeparator)==","&&E.COMMA:case E.TAB:case E.RETURN:if(_()){A.preventDefault();L=true;return false}break;case E.ESC:C.hide();break;default:clearTimeout(S);S=setTimeout(K,V.delay);break}}).focus(function(){F++}).blur(function(){F=0;window.setTimeout(function(){if(M.containFocusFlag)R.focus();else if(!M.mouseDownOnSelect)O()},0)}).click(function(){if(++F>1&&!C.visible())K(0,true)}).bind("search",function(){var _=(arguments.length>1)?arguments[1]:null;function A(A,B){var $;if(B&&B.length)for(var C=0;C<B.length;C++)if(B[C].result.toLowerCase()==A.toLowerCase()){$=B[C];break}if(typeof _=="function")_($);else R.trigger("result",$&&[$.data,$.value])}$.each(G(R.val()),function(_,$){J($,A,A)})}).bind("flushCache",function(){B.flush()}).bind("setOptions",function(){$.extend(V,arguments[1]);if("data"in arguments[1])B.populate()}).bind("unautocomplete",function(){C.unbind();R.unbind();$(H.form).unbind(".autocomplete").bind("input",function(){K(0,true)})});function _(){var B=C.selected();if(!B)return false;var A=B.result;Q=A;if(V.multiple){var E=G(R.val());if(E.length>1){var D=V.multipleSeparator.length,F=$(H).selection().start,I,_=0;$.each(E,function(A,$){_+=$.length;if(F<=_){I=A;return false}_+=D});E[I]=A;A=E.join(V.multipleSeparator)}A+=V.multipleSeparator}R.val(A);N();R.trigger("result",[B.data,B.value]);return true}function K($,_){if(T==E.DEL){C.hide();return}var A=R.val();if(!_&&A==Q)return;Q=A;A=D(A);if(A.length>=V.minChars){R.addClass(V.loadingClass);if(!V.matchCase)A=A.toLowerCase();J(A,U,N)}else{I();C.hide()}}function G(_){if(!_)return[""];if(!V.multiple)return[$.trim(_)];return $.map(_.split(V.multipleSeparator),function(A){return $.trim(_).length?$.trim(A):null})}function D(B){if(!V.multiple)return B;var _=G(B);if(_.length==1)return _[0];var A=$(H).selection().start;if(A==B.length)_=G(B);else _=G(B.replace(B.substring(A),""));return _[_.length-1]}function A(_,A){if(V.autoFill&&(D(R.val()).toLowerCase()==_.toLowerCase())&&T!=E.BACKSPACE){R.val(R.val()+A.substring(D(Q).length));$(H).selection(Q.length,Q.length+A.length)}}function O(){clearTimeout(S);S=setTimeout(N,200)}function N(){var $=C.visible();C.hide();clearTimeout(S);I();if(V.mustMatch)R.search(function($){if(!$)if(V.multiple){var _=G(R.val()).slice(0,-1);R.val(_.join(V.multipleSeparator)+(_.length?V.multipleSeparator:""))}else R.val("")})}function U($,_){if(_&&_.length&&F){I();C.display(_,$);A($,_[0].value);C.show()}else N()}function J(A,F,_){if(!V.matchCase)A=A.toLowerCase();var E=B.load(A);if(E&&E.length)F(A,E);else if((typeof V.url=="string")&&(V.url.length>0)){var G={timestamp:+new Date()};$.each(V.extraParams,function(_,$){G[_]=typeof $=="function"?$():$});$.ajax({mode:"abort",port:"autocomplete"+H.name,dataType:V.dataType,url:V.url,data:$.extend({q:D(A),limit:V.max},G),success:function(_){var $=V.parse&&V.parse(_)||P(_);B.add(A,$);F(A,$)}})}else{C.emptyList();_(A)}}function P(A){var _=[],D=A.split("\n");for(var C=0;C<D.length;C++){var B=$.trim(D[C]);if(B){B=B.split("|");_[_.length]={data:B,value:B[0],result:V.formatResult&&V.formatResult(B,B[0])||B[0]}}}return _}function I(){R.removeClass(V.loadingClass)}};$.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:0,delay:400,matchCase:false,matchSubset:false,matchContains:true,cacheLength:1,max:1000,mustMatch:false,extraParams:{},selectFirst:true,formatItem:function($){return $[0]},formatMatch:null,autoFill:false,width:0,multiple:false,multipleSeparator:", ",highlight:function(_,$){return _.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+$.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:200};$.Autocompleter.Cache=function(F){var C={},B=0;function D(_,$){if(!F.matchCase)_=_.toLowerCase();var A=_.indexOf($);if(F.matchContains=="word")A=_.toLowerCase().search("\\b"+$.toLowerCase());if(A==-1)return false;return A==0||F.matchContains}function E($,A){if(B>F.cacheLength)_();if(!C[$])B++;C[$]=A}function A(){if(!F.data)return false;var D={},H=0;if(!F.url)F.cacheLength=1;D[""]=[];for(var I=0,C=F.data.length;I<C;I++){var B=F.data[I];B=(typeof B=="string")?[B]:B;var A=F.formatMatch(B,I+1,F.data.length);if(A===false)continue;var _=A.charAt(0).toLowerCase();if(!D[_])D[_]=[];var G={value:A,data:B,result:F.formatResult&&F.formatResult(B)||A};D[_].push(G);if(H++<F.max)D[""].push(G)}$.each(D,function(_,$){F.cacheLength++;E(_,$)})}setTimeout(A,25);function _(){C={};B=0}return{flush:_,add:E,populate:A,load:function(A){if(!F.cacheLength||!B)return null;if(!F.url&&F.matchContains){var G=[];for(var E in C)if(E.length>0){var _=C[E];$.each(_,function(_,$){if(D($.value,A))G.push($)})}return G}else if(C[A])return C[A];else if(F.matchSubset)for(var H=A.length-1;H>=F.minChars;H--){_=C[A.substr(0,H)];if(_){G=[];$.each(_,function(_,$){if(D($.value,A))G[G.length]=$});return G}}return null}}};$.Autocompleter.Select=function(Q,J,B,O){var M={ACTIVE:"ac_over"},A,P=-1,D,L="",H=true,_,G;function E(){if(!H)return;_=$("<div/>").hide().addClass(Q.resultsClass).css("position","absolute").appendTo(document.body);G=$("<ul/>").appendTo(_).mouseover(function(_){if(N(_).nodeName&&N(_).nodeName.toUpperCase()=="LI"){P=$("li",G).removeClass(M.ACTIVE).index(N(_));$(N(_)).addClass(M.ACTIVE)}}).click(function(_){$(N(_)).addClass(M.ACTIVE);B();J.focus();return false}).mousedown(function(){O.mouseDownOnSelect=true}).mouseup(function(){O.mouseDownOnSelect=false});if(Q.width>0)_.css("width",Q.width);_.focus(function(){O.containFocusFlag=true}).blur(function(){O.containFocusFlag=false});H=false}function N(_){var $=_.target;while($&&$.tagName!="LI")$=$.parentNode;if(!$)return[];return $}function I(B){A.slice(P,P+1).removeClass(M.ACTIVE);F(B);var $=A.slice(P,P+1).addClass(M.ACTIVE);if(Q.scroll){var _=0;A.slice(0,P).each(function(){_+=this.offsetHeight});if((_+$[0].offsetHeight-G.scrollTop())>G[0].clientHeight)G.scrollTop(_+$[0].offsetHeight-G.innerHeight());else if(_<G.scrollTop())G.scrollTop(_)}}function F($){P+=$;if(P<0)P=A.size()-1;else if(P>=A.size())P=0}function K($){return Q.max&&Q.max<$?Q.max:$}function C(){G.empty();var C=K(D.length);for(var E=0;E<C;E++){if(!D[E])continue;var B=Q.formatItem(D[E].data,E+1,C,D[E].value,L);if(B===false)continue;var _=$("<li/>").html(Q.highlight(B,L)).addClass(E%2==0?"ac_even":"ac_odd").appendTo(G)[0];$.data(_,"ac_data",D[E])}A=G.find("li");if(Q.selectFirst){A.slice(0,1).addClass(M.ACTIVE);P=0}if($.fn.bgiframe)G.bgiframe()}return{display:function($,_){E();D=$;L=_;C()},next:function(){I(1)},prev:function(){I(-1)},pageUp:function(){if(P!=0&&P-8<0)I(-P);else I(-8)},pageDown:function(){if(P!=A.size()-1&&P+8>A.size())I(A.size()-1-P);else I(8)},hide:function(){_&&_.hide();A&&A.removeClass(M.ACTIVE);P=-1},visible:function(){return _&&_.is(":visible")},current:function(){return this.visible()&&(A.filter("."+M.ACTIVE)[0]||Q.selectFirst&&A[0])},show:function(){var D=$(J).offset();_.css({width:typeof Q.width=="string"||Q.width>0?Q.width:$(J).width(),top:D.top+J.offsetHeight,left:D.left}).show();if(Q.scroll){G.scrollTop(0);G.css({maxHeight:Q.scrollHeight});if((navigator.userAgent.indexOf("MSIE")!=-1)&&typeof document.body.style.maxHeight==="undefined"){var B=0;A.each(function(){B+=this.offsetHeight});var C=B>Q.scrollHeight;G.css("height",C?Q.scrollHeight:B);if(!C)A.width(G.width()-parseInt(A.css("padding-left"))-parseInt(A.css("padding-right")))}}},selected:function(){var _=A&&A.filter("."+M.ACTIVE).removeClass(M.ACTIVE);return _&&_.length&&$.data(_[0],"ac_data")},emptyList:function(){G&&G.empty()},unbind:function(){_&&_.remove()}}};$.fn.selection=function(C,F){if(C!==undefined)return this.each(function(){if(this.createTextRange){var $=this.createTextRange();if(F===undefined||C==F){$.move("character",C);$.select()}else{$.collapse(true);$.moveStart("character",C);$.moveEnd("character",F);$.select()}}else if(this.setSelectionRange)this.setSelectionRange(C,F);else if(this.selectionStart){this.selectionStart=C;this.selectionEnd=F}});var _=this[0];if(_.createTextRange){var B=document.selection.createRange(),E=_.value,D="<->",A=B.text.length;B.text=D;var $=_.value.indexOf(D);_.value=E;this.selection($,$+A);return{start:$,end:$+A}}else if(_.selectionStart!==undefined)return{start:_.selectionStart,end:_.selectionEnd}}})(jQuery)